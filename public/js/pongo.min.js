Pongo.UI={$body:$(document.body),$win:$(window),$wrapper:$(".wrapper"),$navbar:$(".navbar"),$overlay:$(".overlay"),$container:$(".container"),$alert_box:$(".alert-msg"),$breadcrumb:$(".breadcrumb-wrapper"),$btn_clicked:null,$box_checked:null,$box_status:null,$layout_radio:null,$modal:null,btn_text:null,lang:null,timeout:1e3,init:function(){this.loadingSpinner(),this.loadingCheckbox()},addSpin:function(){this.btn_text=this.$btn_clicked.html(),this.checkSpin()||(-1==this.btn_text.indexOf("<i")?this.$btn_clicked.prepend(Pongo.Templates.loading_tpl):this.$btn_clicked.find("i").removeClass().addClass("fa fa-refresh fa-spin"))},addShake:function(){Pongo.Form.$form.addClass("shake")},hideModal:function(){this.$modal&&this.$modal.modal("hide")},createAlertMessage:function(e){this.$alert_box.remove();var t=$("<div/>").attr("class","alert-msg").addClass(e.status).html(e.msg);"expired"==e.type?Pongo.Form.redirectTo("login"):(this.$alert_box=t,Modernizr.touch?(this.$alert_box.addClass("fixfixed"),this.$body.animate({scrollTop:0},0).prepend(t)):this.$body.prepend(t))},checkSpin:function(){return this.$btn_clicked.find("i").hasClass("fa-spin")},checkBoxSpin:function(){return this.$box_checked?this.$box_checked.next("span").find("i").hasClass("fa-spin"):!1},checkEmptyList:function(){return Pongo.Nestable.$item_list.children().html()},activePageList:function(){return Pongo.Nestable.$page_list.filter("[rel="+this.lang+"]")},loadingSpinner:function(){var e=this;$(".pongo-loading").on("click",function(t){t.preventDefault();var o=$(this);e.$btn_clicked=o,e.addSpin()})},loadingCheckbox:function(){var e=this;$(".pongo-checking").on("click",":checkbox",function(t){if(e.$box_checked=$(this),e.checkBoxSpin())t.preventDefault();else{e.$box_status=this.checked?!0:!1,e.$box_status&&t.preventDefault();var o=e.$box_checked.next("span");o.append(Pongo.Templates.loading_tpl)}})},paginateList:function(e){$.LoadNext({container:".pongo-paginating",next_link:"li:last-child a",item:e,label:Pongo.load,btn_class:"load-more",onClickNext:this.paginateSpinner,onLoadComplete:this.paginateSpinnerReset})},paginateSpinner:function(){var e=$(this);Pongo.UI.$btn_clicked=e,Pongo.UI.addSpin()},paginateSpinnerReset:function(){Pongo.UI.resetBtn()},resetCheckbox:function(){this.$box_checked.next("span").empty(),this.$box_checked.prop("checked",this.$box_status)},resetOtherCheckboxes:function(){this.$box_checked.parents(".pongo-select").find("input[type=checkbox]").prop("checked",!1)},resetBtn:function(){var e=this;this.btn_text&&this.$btn_clicked&&(e.$btn_clicked.html(e.btn_text),e.$btn_clicked=null)},resetShake:function(){Pongo.Form.$form.removeClass("shake")},resetFieldErrors:function(){var e=Pongo.Form.$form;e.find(".form-group").removeClass("has-error"),e.find(".err").remove()},resetModalShake:function(){this.$modal&&this.$modal.on("hidden.bs.modal",function(){Pongo.Form.$form&&Pongo.Form.$form.removeClass("shake")})}},Pongo.Block={editor:null,formatTag:function(e,t){switch(e){case"img":return'<img src="'+t+'" />';default:return t}},insertContent:function(e){this.editor.insertContent(e)},insertMarker:function(){var e=this;$(".list").on("click",".insert",function(){var t=$(this).attr("data-tag"),o=$(this).attr("data-default"),n=t?e.formatTag(t,o):o;n&&e.insertContent(n)})},settingsTinyMce:function(){var e=[],t=[];return e.toolbar="formatselect | bold italic underline strikethrough | link | bullist numlist | table | cut copy paste | fullscreen code | undo redo",t.toolbar="formatselect | bold italic  underline strikethrough | bullist numlist | link image | undo redo",e.plugins="autolink, autoresize, code, contextmenu, fullscreen, link, paste, print, table",t.plugins="autolink, autoresize, image, link",Pongo.Utils.mobileBrowser()?t:e},initTinyMce:function(e){this.editor=e}},Pongo.Factory={url:null,tpl:null,createBlock:function(){var e=this;$("#create-block").on("click",function(t){t.preventDefault();var o=($(this),$("input[name=current_page]").val()),n=$("input[name=zone]:checked").val();e.tpl=Pongo.Templates.new_block_tpl,e.url=Pongo.Utils.url("api/block/create"),e.sendRequest({lang:Pongo.UI.lang,page_id:o,zone:n})})},createPage:function(){var e=this;$("#create-page").on("click",function(t){t.preventDefault(),e.tpl=Pongo.Templates.new_page_tpl,e.url=Pongo.Utils.url("api/page/create"),e.sendRequest({lang:Pongo.UI.lang})})},createRole:function(){var e=this;$("#create-role").on("click",function(t){t.preventDefault(),e.tpl=Pongo.Templates.new_role_tpl,e.url=Pongo.Utils.url("api/role/create"),e.sendRequest(null)})},createUser:function(){var e=this;$("#create-user").on("click",function(t){t.preventDefault(),e.tpl=Pongo.Templates.new_user_tpl,e.url=Pongo.Utils.url("api/user/create"),e.sendRequest(null)})},processResponse:function(e){if("success"==e.status){var t=(Pongo.UI.activePageList(),_.template(this.tpl)),o=t(e);"block"==e.render&&this.renderNewBlock(o),"page"==e.render&&this.renderNewPage(o),"role"==e.render&&this.renderNewRole(o),"user"==e.render&&this.renderNewUser(o),Pongo.UI.createAlertMessage(e,null,null)}},renderNewBlock:function(e){var t=Pongo.Nestable.$block_list;t.find("a.new").removeClass("new"),t.find(".list-empty").remove(),t.children().prepend(e),t.nestable("serialize")},renderNewPage:function(e){var t=Pongo.UI.activePageList();t.find("a.new").removeClass("new"),t.find(".list-empty").remove(),t.children().prepend(e),t.nestable("serialize")},renderNewRole:function(e){var t=Pongo.Nestable.$item_list;t.find(".list-empty").remove(),t.children().append(e),t.nestable("serialize")},renderNewUser:function(e){var t=Pongo.Nestable.$item_list;t.find(".list-empty").remove(),t.children().first().prepend(e),t.nestable("serialize")},sendRequest:function(e){this.url?$.ajax({type:"POST",url:this.url,data:e,success:this.processResponse,context:this,dataType:"json"}).done(function(){Pongo.UI.resetBtn()}):console.log("No this.url")}},Pongo.Form={url:null,redirect_uri:null,$form:null,$item:null,init:function(){this.confirmDialog(),this.submitAjax(0),this.submitForm(),console.log("init Form")},confirmDialog:function(){var e=this;$(".pongo-confirming").on("click",".pongo-confirm",function(t){t.preventDefault();var o=$(this),n=o.data("id");e.$item=o.parents("li").filter("[data-id="+n+"]"),Pongo.UI.$modal=$(o.data("target")),Pongo.UI.$modal.find("input[name=item_id]").val(n),Pongo.UI.resetModalShake()})},submitForm:function(){var e=this;$(".pongo-form-submit").on("click",function(t){t.preventDefault();var o=$(this);e.$form=o.parents("form"),e.$form.submit()})},submitAjax:function(e){var t=this;$(".pongo-ajax-submit").on("click",function(o){o.preventDefault();var n=$(this);t.$form=n.parents("form"),Pongo.UI.resetShake(),t.url=t.$form.attr("action"),t.sendRequest(e)})},sendRequest:function(e){if(this.url){var t=this,o=1e3*e;setTimeout(function(){$.ajax({type:"POST",url:t.url,data:t.$form.serialize(),success:t.validateForm,context:t,dataType:"json"}).done(function(){Pongo.UI.resetBtn()})},o)}else console.log("No this.url")},fieldErrors:function(e){Pongo.UI.addShake(),$.each(e,function(e,t){$item=$(".form-group[rel="+e+"]"),$item.find(".help-block").remove(),$item.addClass("has-error"),$item.children("label[for="+e+"]").append('<span class="err"> - '+t+"</span>")})},redirectTo:function(e){window.location=Pongo.Utils.url(e)},redirectUrl:function(e){window.location=e},removeListItem:function(){var e=this.$item.parent();this.$item.remove(),e.html().trim()||(e.hasClass("pongo-active")?e.append(Pongo.Templates.empty_tpl):(e.siblings("[data-action]").remove(),e.remove())),Pongo.UI.hideModal()},validateForm:function(e){Pongo.UI.resetFieldErrors(),e.errors&&this.fieldErrors(e.errors),e.remove&&this.removeListItem(e.remove),"error"==e.status&&Pongo.UI.addShake(),e.msg&&Pongo.UI.createAlertMessage(e),e.page&&Pongo.Nestable.pageUpdate(e.page),e.redirect&&this.redirectUrl(e.route)}},Pongo.Nestable={$page_list:$(".dd"),$item_list:$(".dl"),$block_list:$(".db"),$item_moved:null,$spinner_holder:null,dropped_id:null,dropped_class:null,init:function(){this.pageList(),this.pageExpColl()},checkSpin:function(){return this.$spinner_holder.hasClass("fa-spin")},blockList:function(){var e=this,t=e.$block_list.hasClass("pongo-moving");e.$block_list.nestable({maxDepth:0,rootClass:"db",listClass:"db-list",dragClass:"dd-dragel right",dropCallback:function(o,n){e.$item_moved=n,e.reorderItem(o,"a > i",t)}}).on("reorder",function(){e.reorderItemPost(e.$block_list,"api/page/move/blocks",t)})},pageExpColl:function(){var e=this;$(".page-controls").on("click",function(t){var o=$(t.target),n=o.data("action");"expand-all"===n&&e.$page_list.nestable("expandAll"),"collapse-all"===n&&e.$page_list.nestable("collapseAll")})},pageList:function(){var e=this,t=e.$page_list.hasClass("pongo-moving");e.$page_list.nestable({dropCallback:function(o,n){e.$item_moved=n,e.reorderItem(o,"a > i",t)}}).on("reorder",function(){var o=e.$page_list.filter("[rel="+Pongo.UI.lang+"]");e.reorderItemPost(o,"api/page/move",t)})},pageUpdate:function(e){$list=Pongo.UI.activePageList(),$item=$list.find("li[data-id="+e.id+"] > p"),$item.find("span").html(e.name);var t=$item.find(".fa-home");e.home?($list.find(".fa-home").hide(),t.show()):t.hide()},roleList:function(){var e=this,t=e.$item_list.hasClass("pongo-moving");e.$item_list.nestable({maxDepth:0,rootClass:"dl",listClass:"dl-list",notClass:"dl-not",itemClass:"dl-item",dragClass:"dl-dragel",dropCallback:function(o,n){e.$item_moved=n,e.reorderItem(o,".fa-pencil-square-o",t)}}).on("reorder",function(){var o=e.$item_list;e.reorderItemPost(o,"api/role/move",t)})},reorderItem:function(e,t,o){this.dropped_id=e,o&&this.reorderItemLoading(t)},reorderItemLoading:function(e){this.dropped_id;this.$spinner_holder=this.$item_moved.find(e);var t=this.$spinner_holder;this.dropped_class=t.attr("class"),this.checkSpin()?(this.$spinner_holder.removeClass().addClass(this.dropped_class),t.removeClass().addClass("fa fa-refresh fa-spin")):t.removeClass().addClass("fa fa-refresh fa-spin")},reorderItemReset:function(){var e=(this.dropped_id,this.$spinner_holder);e.removeClass().addClass(this.dropped_class)},reorderItemPost:function(e,t,o){var n=this,a=n.reorderStringify(e),i=$("input[name=current_page]").val();$.post(Pongo.Utils.url(t),{items:a,page_id:i},function(e){Pongo.UI.createAlertMessage(e,null,null)},"json").done(function(){o&&n.reorderItemReset()})},reorderStringify:function(e){if(JSON&&e){var t=e.nestable("serialize");return JSON.stringify(t)}var o={status:"error",msg:"Unsupported browser!"};Pongo.UI.createAlertMessage(o,null,null)}},Pongo.Templates={empty_tpl:'<li class="list-empty"><p>'+Pongo.noresult+'</p><label class="fake"></label></li>',loading_tpl:'<i class="fa fa-refresh fa-spin"></i> ',new_role_tpl:'<li class="dl-item move" data-id="<%= id %>"><p class="dd-handle"><%= name %></p><label><input type="checkbox" value="<%= id %>" class="pongo-checkbox"><span></span></label><div class="btn-edit"><a href="<%= url_edit %>" class="btn btn-sm btn-primary"><i class="fa fa-pencil-square-o"></i></a>\n<a href="#" data-toggle="modal" data-target=".pongo-delete" data-id="<%= id %>" class="btn btn-sm btn-danger pongo-confirm"><i class="fa fa-trash-o"></i></a></div></li>',new_page_tpl:'<li class="dd-item move" data-id="<%= id %>"><p class="dd-handle"><%= name %></p><label><input type="checkbox" value="<%= id %>" class="pongo-checkbox"><span></span></label><a href="<%= url %>" data-link="page" data-arrow="right" data-toggle="modal" data-target=".page-delete" data-id="<%= id %>" class="<%= cls %>"><i class="fa fa-trash-o"></i></a></li>',new_user_tpl:'<li class="dl-item" data-id="<%= id %>"><p class="dd-handle"><%= username %></p><label><input type="checkbox" value="<%= id %>" class="pongo-checkbox"><span></span></label><div class="btn-edit"><a href="<%= url_edit %>" class="btn btn-sm btn-primary"><i class="fa fa-pencil-square-o"></i></a>\n<a href="#" data-toggle="modal" data-target=".pongo-delete" data-id="<%= id %>" class="btn btn-sm btn-danger pongo-confirm"><i class="fa fa-trash-o"></i></a></div></li>',new_block_tpl:'<li class="dd-item move" data-id="<%= id %>"><p class="dd-handle"><%= name %></p><% if(is_active == 0) { %><label><input type="checkbox" value="<%= id %>" class="pongo-checkbox"><span></span></label><a href="#" data-link="block" data-arrow="left" data-toggle="modal" data-target=".pongo-delete" data-id="<%= id %>" class="pongo-confirm"><i class="fa fa-trash-o"></i></a><% } else { %><label><input type="checkbox" value="<%= id %>" class="pongo-checkbox" checked="checked"><span></span></label><a href="<%= url %>" data-link="block" data-arrow="left" data-id="<%= id %>"><i class="fa fa-chevron-left"></i></a><% } %></li>'},Pongo.Toggle={$active_pane:$(".tab-pane.active"),$change_lang:$("#change-lang"),$block_wrapper:null,$was_checked:null,init:function(){this.togglePages(),this.toggleOptions(),this.toggleLang(),this.toggleSearch(),this.toggleSelect(),this.toggleValid(),this.toggleEnabling(),this.toggleSetting(),this.untoggleOverlay(),this.toggleDelete("a","pongo-confirm")},toggleSelect:function(){var e=this;$(".pongo-select").on("click",".pongo-checkbox",function(t){var o=$(this);if(e.$was_checked=o.parents(".pongo-select").find("input[type=checkbox]:checked"),Pongo.UI.checkBoxSpin()&&Pongo.UI.$box_checked!=o&&Pongo.UI.resetCheckbox(),Pongo.UI.$box_checked=o,Pongo.UI.resetOtherCheckboxes(),Pongo.UI.checkBoxSpin())t.preventDefault();else{var n=o.val(),a=o.parents("form").attr("action"),i=o.parents("form").data("user");$.post(a,{item_id:n,user_id:i},function(t){"error"==t.status?e.$was_checked.prop("checked",!0):Pongo.UI.$box_status=!0,Pongo.UI.createAlertMessage(t,null,null)},"json").done(function(){Pongo.UI.resetCheckbox()})}})},toggleValid:function(){$(".pongo-active").on("click",".pongo-checkbox",function(e){var t=$(this);if(Pongo.UI.checkBoxSpin()&&Pongo.UI.$box_checked!=t&&Pongo.UI.resetCheckbox(),Pongo.UI.$box_checked=t,Pongo.UI.checkBoxSpin())e.preventDefault();else{var o=t.val(),n=$("input[name=current_page]").val(),a=this.checked?1:0,i=t.parents("form").attr("action");$.post(i,{item_id:o,page_id:n,action:a},function(){},"json").done(function(){Pongo.UI.resetCheckbox()})}})},toggleEnabling:function(){$(".pongo-enabling").on("click",".pongo-checkbox",function(e){var t=$(this);if(Pongo.UI.checkBoxSpin()&&Pongo.UI.$box_checked!=t&&Pongo.UI.resetCheckbox(),Pongo.UI.$box_checked=t,Pongo.UI.checkBoxSpin())e.preventDefault();else{var o=t.attr("name"),n=this.checked?!0:!1,a=t.parents("form").attr("action");$.post(a,{item_name:o,action:n},function(e){Pongo.UI.createAlertMessage(e,null,null)},"json").done(function(){Pongo.UI.resetCheckbox()})}})},toggleSetting:function(){$(".pongo-setting").on("change","select",function(e){e.preventDefault();var t=$(this),o=t.attr("name"),n=t.val(),a=t.parents("form").attr("action");$.post(a,{item_name:o,value:n},function(e){Pongo.UI.createAlertMessage(e,null,null)},"json").done(function(){Pongo.UI.resetCheckbox()})})},toggleDelete:function(e,t){var o=[];$(".pongo-deleting").on("click",":checkbox",function(){var n=$(this),a=this.checked?!1:!0,i=n.parent().next(e),l=i.data("id"),r=i.data("link");void 0==o[l]&&(o[l]=i.hasClass("active"));var s=Pongo.Utils.url(r+"/edit/"+i.data("id")),c=(i.attr("href"),i.data("arrow")),d="fa-chevron-"+c,g="page"==i.data("link")?".page-delete":".pongo-delete";a?(i.addClass(t).attr("data-toggle","modal").attr("data-target",g).attr("href","#"),o[l]&&i.removeClass("active"),i.find("i").toggleClass(d+" fa-trash-o")):(i.removeClass(t).removeAttr("data-toggle").removeAttr("data-target").attr("href",s),o[l]&&i.addClass("active"),i.find("i").toggleClass("fa-trash-o "+d))})},toggleLang:function(){var e=this;Pongo.UI.lang=this.$change_lang.val(),Pongo.UI.activePageList().show(),this.$change_lang.on("change",function(){Pongo.UI.lang=e.$change_lang.val(),Pongo.Nestable.$page_list.hide(),Pongo.UI.activePageList().show(),$.post(Pongo.Utils.url("api/page/lang"),{lang:Pongo.UI.lang},function(e){$(".breadcrumb > li").first().html(e.lang),Pongo.UI.createAlertMessage(e,null,null)},"json")})},toggleOverallLayout:function(){this.togglePartials("template"),this.togglePartials("header"),this.togglePartials("layout"),this.togglePartials("footer"),this.toggleLoadBlocks()},togglePartials:function(e){$(".pongo-layout-changing").on("change","#"+e,function(t){t.preventDefault();var o=$(this);if("layout"!=e){var n=o.find("option:selected").text();$("[data-name="+e+"]").html(n.toUpperCase())}else{var a=Pongo.Utils.url("api/page/change/layout");$.post(a,{layout:o.val()},function(e){var t=$("div[data-zone]:first").parents(".layout-wrapper").find(".row");t.slice(1,t.length-1).remove();var o=t.eq(0);o.after(e)})}})},toggleLoadBlocks:function(){var e=this;$(".pongo-blocks-loading").on("click",":radio",function(){var t=$(this),o=t.val(),n=$("input[name=current_page]").val();Pongo.UI.$layout_radio=t,e.$block_wrapper=Pongo.Nestable.$block_list.find("ol:first-child");var a=$("[data-zone="+o+"]").find("span").html();$(".sidebar.right").find("h2 > span").html(a),e.$active_pane.find(".pongo-ajax-submit").trigger("click");var i=Pongo.Utils.url("api/page/load/blocks");$.post(i,{page_id:n,zone:o},function(t){if(t){var o=_.template(Pongo.Templates.new_block_tpl);$.each(t,function(t,n){n.is_active=0==n.pivot.is_active?0:1,n.url=0==n.is_active?"#":Pongo.Utils.url("block/edit/"+n.id),e.$block_wrapper.append(o(n))})}},"json"),Pongo.UI.$body.toggleClass("push-left")})},toggleOptions:function(){$(".options-toggle").on("click",function(e){e.preventDefault(),Pongo.UI.$body.toggleClass("push-left")})},togglePages:function(){var e=this;$(".pages-toggle").on("click",function(t){t.preventDefault(),Pongo.UI.$body.hasClass("push-left")&&(Pongo.UI.$body.removeClass(),e.resetBlocksLayout()),Pongo.UI.$body.toggleClass("push-right")})},toggleSearch:function(){$(".search-toggle").on("click",function(e){e.preventDefault(),Pongo.UI.$breadcrumb.toggleClass("open-search")})},untoggleOverlay:function(){var e=this;Pongo.UI.$overlay.on("click",function(){Pongo.UI.$body.removeClass(),e.resetBlocksLayout()})},resetBlocksLayout:function(){Pongo.UI.$layout_radio&&(Pongo.UI.$layout_radio.prop("checked",!1),this.$block_wrapper.empty())}},Pongo.Utils={mobileBrowser:function(){return jQuery.browser.mobile?!0:!1},url:function(e){return Pongo.base+"/"+e}},Pongo.VM={countChars:function(e,t){var o=e().length,n=e();return o>t?(e(n.substring(0,t)),0):t-o},makeSlug:function(e){return e.trim().toLowerCase().replace(/ +/g,"-").replace(/-+/g,"-")},pageEdit:function(){var e=this;e.itemName=ko.observable($("#name").val()),e.pageSlug=ko.observable($("#slug").val()),e.slug=ko.computed(function(){return e.pageSlug()}),e.pageTitle=ko.observable($("#title").val()),e.pageDescr=ko.observable($("#descr").val()),e.titleLen=ko.computed(function(){var t=e.pageTitle;return Pongo.VM.countChars(t,70)}),e.descrLen=ko.computed(function(){var t=e.pageDescr;return Pongo.VM.countChars(t,250)}),e.createSlugName=function(){var t=Pongo.VM.makeSlug(e.itemName());$("#slug").val(t),$("#slug-last").html(t)},e.createSlugThis=function(){var e=$("#slug"),t=e.val(),o=Pongo.VM.makeSlug(t);$("#slug").val(o),$("#slug-last").html(o)}},roleEdit:function(){var e=this;e.itemName=ko.observable($("#name").val())},userEdit:function(){var e=this;e.itemName=ko.observable($("#username").val()),e.itemPassword=ko.observable($("#password").val()),e.itemConfirmed=ko.observable($("#password_confirmation").val()),e.iconFeedbackError=ko.observable(!1),e.iconFeedback=ko.observable(!1),e.iconCheckError=ko.observable(!1),e.iconCheck=ko.observable(!1),e.fieldStatus=ko.computed(function(){var t=e.itemPassword().length,o="form-group";return t>0&&8>t&&(o+=" has-error has-feedback",e.iconFeedbackError(!0),e.iconFeedback(!1)),t>=8&&(o+=" has-success has-feedback",e.iconFeedbackError(!1),e.iconFeedback(!0)),0==t&&(e.iconFeedbackError(!1),e.iconFeedback(!1)),o},e),e.passwordCheck=ko.computed(function(){var t="form-group",o=e.itemConfirmed().length;return o>0&&e.itemConfirmed()===e.itemPassword()&&(e.iconCheckError(!1),e.iconCheck(!0),t+=" has-success has-feedback"),o>0&&e.itemConfirmed()!==e.itemPassword()&&(e.iconCheckError(!0),e.iconCheck(!1),t+=" has-error has-feedback"),0==o&&(e.iconCheckError(!1),e.iconCheck(!1)),t})}},$(function(){Pongo.UI.init(),console.log("pongo.js loaded and minified!",new Date)});